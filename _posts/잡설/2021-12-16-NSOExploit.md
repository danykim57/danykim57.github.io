---
title:  "NSO 제로클릭 해킹"
header:
  teaser: "https://farm5.staticflickr.com/4076/4940499208_b79b77fb0a_z.jpg"
categories: 
  - etc
tags:
  - Security
---
  
  구글 프로젝트 제로 팀에서 올린 NSO 제로클릭 해킹 관련 글이다.
  
  NSO는 이스라엘의 Niv, Shalev and Omri라는 회사로서 원격으로 사용자의 링크 클릭 없이 스마트폰을 해킹하는 페가수스라는
  
  스파이웨어를 만드는 회사 이다.
  
  페가수스 스파이웨어는 이스라엘 정부에 의해서 정보전 무기로 인증받고 어떠한 형태의 수출도 이스라엘 정부의 인허가가 있어야 한다.
  
  2021년 11월 3일에 미연방정부는 NSO를 미연방의 외교 정책과 안보에 위협을 가하는 업체로 등록을 하였고
  
  2021년 11월 23일에 애플은 NSO를 애플 상품에 대한 공격에 대해서 고소를 하였다.
  
  NSO가 만드는 상품들은 Access-As-a-proeuct(AAAP)로 표방하고 있으며 국가 규모의 인사들에게 사이버 해킹 서비스를 
  
  제공하는 것이 비즈니스 모델이다.
  
  2016년에 사용자가 아이폰 iMessage로 보내진 링크를 클릭하면 원격 조종이 가능한 스파이웨어를 개발하였다.
  
  지금은 그 형태가 발달되어서 사용자가 메세지를 받기만 해도 해킹이되는 방식인 제로클릭이 되었다.
  
  즉, 상대방이 나의 애플 ID 계정 아이디나 전화번호만 알아도 해킹의 대상이 될 수 있다는 것이다.
  
  NSO는 gif 파일을 애플의 iMessage가 파싱과 처리를 할 때 생기는 보안 취약점을 파고 들었다.
  
  gif 파일은 연속된 이미지를 무한반복하는 그림 파일로서 백그라운드에서 이미지 처리가 일어나는데
  
  NSO는 이점을 이용해서 파일 확장자 이름만 gif이고 20개의 코덱을 포함하며 수백개에서 
  
  수천줄의 코드를 원격 실행 시킬 수 있는 가짜 gif을 만들었다.
  
  애플은 iOS 14.8.1부터 이 취약점을 막고 iOS 15.0부터는 아예 BlastDoor에서 gif 파싱과 처리가 되도록 바꾸었다.
  
  가짜 gif는 실제로 CoreGraphics PDF parser의 보안취약점을 노리도록 설계되었다.
  
  pdf는 웹브라우저에서 자바스크립트로 쉽게 이용이 가능하고 어떤 기기에서도 웹브라우저가 있으면 볼 수 있는 편의성으로
  
  많이 쓰이는 문서 파일 확장자이다. CoreGraphics PDF parser가 임의로 설정된 자바스크립트 코드를 실행시킬 수 
  
  있다는 것은 아니다 그러나 CoreGraphics PDF parser에는 예전 네트워크 기술의 한계로 만든 미국 국내용 텍스트 이미지 압축 
  
  기술인 JBIG2가 탑재되어 있다.

   JBIG2는 손실(lossy) 압축과 비손실(lossless) 압축을 둘다 지원하는데 손실 압축에서는 영어에서 자주 쓰이는
   
  알파벳인 e나 a와 같이 자주 등장하는 알파벳 그림의 데이터를 조각내고(segmentation) 나중에 날려버린 이미지를 채워넣는(substitution) 
  
  방식을 쓴다. 이 방식을 쓸경우에 회사에서 청구서 같은 것을 보냈을 때 잘못된 글자가 찍혀나오는 경우가 있기에
  
  글자 정보가 중요한 경우에는 비손실 압축 방식인 Refinement coding을 쓴다.
  
  이때 비트 연산(AND, OR, XOR, XNOR)을 써서 비손실 압축된 이미지와 원래 이미지 사이의 차이를 표현하는데 추가로
  
  데이터의 문맥적 해석을 하여서 최대한 비손실로 압축을 하고 압축을 푸는 방식이다.
  
   애플 생태계는 폐쇄적인 것으로 유명하지만 CoreGraphics PDF 디코더의 JBIG2는 Xpdf에서 가져와서 구현을 하였다.
   
  Xpdf에서 보안 취약점은 조각화(segmented) 레퍼런스들을 처리할 때 일어나는데 numSys의 32비트 정수값을 의도적으로
  
  오버플로우를 시켜서 조각화된 레퍼런스의 포인터를 강제로 버퍼가 아닌 JBIG2Bitmap으로 바꿔버리는 것이다.
  
  JBIG2Bitmap은 이미지의 가로, 세로, 줄, 세그먼트 숫자등을 보관하고 있는 메모리인데 오버플로우를 정교하게 조정하면
  
  아이폰의 운영체제가 추가로 JBIG2Bitmaps 처리를 위해 4GB의 가상 메모리를 배분받을 수 있다.
  
  이 빈 메모리에서 이제 가짜 gif가 자원에 대한 운영 권한을 가지게 되면서 파일에 들어있는 비트 연산자로 이루어진 코드들로 
  
  가상의 논리 회로를 구현할 수 있게 된다. 이 가상의 논리 회로는 아이폰을 원격조종을 하는 단말기 역할을 하게 된다.
  
  
   
  
출처:

https://googleprojectzero.blogspot.com/2021/12/a-deep-dive-into-nso-zero-click.html